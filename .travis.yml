language: php

php:
  - 5.6

before_script:
  - composer self-update
  - composer install --prefer-source --no-interaction --dev

env:
  - TEST_CONFIG="app/phpunit.xml.dist"

addons:
  apt:
    packages:
      - sshpass

script:
  - ./bin/security-checker security:check
  - phpunit -c $TEST_CONFIG --colors --coverage-text
  - ./bin/phpmd src/ text codesize,naming

after_success:
  - export SYMFONY_ENV=prod && composer install --no-dev -o
  - mkdir deploy
  - find . -maxdepth 1 | grep -vE "deploy|.|.."| xargs -i mv {} ./deploy
  - tar -czf new_build.tgz deploy/*
  - export SSHPASS=$DEPLOY_PASS
  - sshpass -e scp -o stricthostkeychecking=no new_build.tgz $DEPLOY_USER@$DEPLOY_HOST:$DEPLOY_PATH
  - sshpass -e scp -o stricthostkeychecking=no ssh $DEPLOY_USER@$DEPLOY_HOST tar -xzf $DEPLOY_PATH/new_build.tgz -C $DEPLOY_PROD_PATH
  - sshpass -e scp -o stricthostkeychecking=no ssh $DEPLOY_USER@$DEPLOY_HOST rm $DEPLOY_PATH/new_build.tgz

notifications:
  on_success: never
  on_failure: always